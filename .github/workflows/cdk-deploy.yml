name: cdk deploy

on:
  push:
    branches: [master]

jobs:
  deploy:
      runs-on: ubuntu-latest
      steps:
          - name: "checkout branch"
            uses: actions/checkout@v2
          - name: "setup node"
            uses: actions/setup-node@v1
            with:
                node-version: 12
                registry-url: "https://registry.npmjs.org/"
          - name: "get repo name as environment variable"
            uses: franzdiebold/github-env-vars-action@v1.0.0
          - name: "install set-topic-attributes lambda"
            run: |
                cd setTopicAttributes
                npm ci
          - name: "test set-topic-attributes lambda"
            run: |
                cd setTopicAttributes
                npm run test
          - name: "package set-topic-attributes lambda"
            run: |
                cd setTopicAttributes
                npm run pre-package
          - name: "install infrastructure stack"
            run: |
                cd infrastructure
                npm ci
          - name: "test infrastructure stack"
            run: |
                cd infrastructure
                npm run test
          - name: "build infrastructure stack"
            run: |
                cd infrastructure
                npm run build
          - name: "deploy infrastructure stack"
            env:
              AWS_ACCESS_KEY_ID: "${{secrets.AWS_ACCESS_KEY_ID_DEV}}"
              AWS_ACCOUNT_ID: "${{secrets.AWS_ACCOUNT_ID_DEV}}"
              AWS_SECRET_ACCESS_KEY: "${{secrets.AWS_SECRET_ACCESS_KEY_DEV}}"
              AWS_DEFAULT_REGION: "eu-west-1"
              PUSHED_BY: "github"
            run: |
              cd infrastructure
              npx cdk bootstrap \
              --role-arn arn:aws:iam::$AWS_ACCOUNT_ID:role/CloudformationDeploymentRole \
              --toolkit-stack-name $GITHUB_REPOSITORY_NAME-cdk-toolkit
              npx cdk deploy \
              --require-approval never \
              --role-arn arn:aws:iam::$AWS_ACCOUNT_ID:role/CloudformationDeploymentRole \
              --toolkit-stack-name $GITHUB_REPOSITORY_NAME-cdk-toolkit
          - name: Invoke set-topic-attributes Lambda
            uses: gagoar/invoke-aws-lambda@master
            with:
              AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_INVOKE_TOPIC_LAMBDA_USER_DEV }}
              AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_INVOKE_TOPIC_LAMBDA_USER_DEV }}
              REGION: "eu-west-1"
              FunctionName: set-topic-attributes
              Payload: '{}'
